@using BookShop.BLL.ConfigurationModel.OrderDetailModel;
@using System.Globalization;
@model BookShop.BLL.ConfigurationModel.OrderModel.OrderViewModel

@{
	ViewData["Title"] = "Chi tiết đơn hàng";
	Layout = "~/Areas/Admin/Views/Shared/_adminLayout.cshtml";
	List<OrderDetailViewModel> details = ViewBag.Details;
	int total = 0;
}

<h1>OrderDetails</h1>

<div>
	<h4>OrderViewModel</h4>
	<hr />
	<div class="row">
		<dl class="col-8">
			<dd class="col-sm-10" hidden>
				@Html.DisplayFor(model => model.Id)
			</dd>
			<dt class="col-sm-2">
				@Html.DisplayNameFor(model => model.Code)
			</dt>
			<dd class="col-sm-10">
				@Html.DisplayFor(model => model.Code)
			</dd>
			<dt class="col-sm-2">
				@Html.DisplayNameFor(model => model.Receiver)
			</dt>
			<dd class="col-sm-10">
				@Html.DisplayFor(model => model.Receiver)
			</dd>
			<dt class="col-sm-2">
				@Html.DisplayNameFor(model => model.Phone)
			</dt>
			<dd class="col-sm-10">
				@Html.DisplayFor(model => model.Phone)
			</dd>
			<dt class="col-sm-2">
				@Html.DisplayNameFor(model => model.Email)
			</dt>
			<dd class="col-sm-10">
				@Html.DisplayFor(model => model.Email)
			</dd>
			<dt class="col-sm-2">
				@Html.DisplayNameFor(model => model.CreatedDate)
			</dt>
			<dd class="col-sm-10">
				@Html.DisplayFor(model => model.CreatedDate)
			</dd>
			<dt class="col-sm-2">
				@Html.DisplayNameFor(model => model.Description)
			</dt>
			<dd class="col-sm-10">
				@Html.DisplayFor(model => model.Description)
			</dd>
			<dt class="col-sm-2">
				@Html.DisplayNameFor(model => model.Address)
			</dt>
			<dd class="col-sm-10">
				@Html.DisplayFor(model => model.Address)
			</dd>
			<dt class="col-sm-2">
				@Html.DisplayNameFor(model => model.Shipfee)
			</dt>
			<dd class="col-sm-10">
				@Html.DisplayFor(model => model.Shipfee)
			</dd>
			<dt class="col-sm-2">
				@Html.DisplayNameFor(model => model.Total)
			</dt>
			<dd class="col-sm-10">
				@Html.DisplayFor(model => model.Total)
			</dd>
			<dt class="col-sm-2">
				@Html.DisplayNameFor(model => model.NamePromotion)
			</dt>
			<dd class="col-sm-10">
				@Html.DisplayFor(model => model.NamePromotion)
			</dd>
			<dt class="col-sm-2">
				@Html.DisplayNameFor(model => model.Status)
			</dt>
			<dd class="col-sm-10">
				@Html.DisplayFor(model => model.Status)
			</dd>
		</dl>
		<div class="col-4">
			<ul class="ps-0" style="list-style: none">
				@foreach (var item in details)
				{
					total += (item.Price * item.Quantity);
					<li class="row">
						<div class="col-3 position-relativelative">
							<img class="bg-light" src="@item.Img" style="width: 100%; z-index: 0" />
							<span class="badge" style="color: orange; position: absolute; top: 0; right: 15px; background-color: gray">@item.Quantity</span>
						</div>
						<span class="col-6">@item.NameProduct</span>
						<span class="col-3">@string.Format(new CultureInfo("vi-VN"), "{0:C0}", item.Price)</span>
					</li>
				}
			</ul>
			<div id="textModify">
				<label>Ghi chú đơn hàng</label>
				<textarea id="modifyChange" class="form-control" rows="5" ></textarea>
				<label class="text-warning" id="valid" hidden></label>
			</div>
		</div>
	</div>
</div>
<div>
	<a href="@Url.Action("Index", "OrderManage")" class="btn btn-outline-info"><i class="fa-solid fa-arrow-left"></i> Trở lại</a>
	<button class="btn btn-outline-danger" id="acceptOrder" hidden onclick="AcceptOrder()">Xác nhận đơn hàng</button>
	<button class="btn btn-outline-danger" id="deliveryOrder" hidden onclick="DeliveryOrder()">Xác nhận giao hàng</button>
	<button class="btn btn-outline-danger" id="completeOrder" hidden onclick="SuccessOrder()">Xác nhận hoàn thành đơn hàng</button>
	<button class="btn btn-outline-danger" id="returnOrder" hidden onclick="ReturnOrder()">Xác nhận trả hàng</button>
	<button class="btn btn-outline-danger" id="handleReturn" hidden onclick="HandleReturn()">Xử lý hàng trả</button>
	<button class="btn btn-outline-danger" id="completeReturn" hidden onclick="SuccessReturn()">Xác nhận xử lý hoàn tất</button>
	<button class="btn btn-outline-danger" id="cancelOrder" hidden onclick="CancelOrder()">Xác nhận hủy đơn</button>
	<button class="btn btn-outline-danger" id="closeOrder" hidden onclick="CloseOrder()">Xác nhận đóng đơn</button>
	<a href="@Url.Action("Edit", "OrderManage", new { id = Model.Id })" id="modifyOrder" hidden class="btn btn-outline-warning"> Chỉnh sửa</a>

</div>
<script type="text/javascript">
	function checkStatus() {
		switch (@Model.Status) {
			case 1:
				document.getElementById('acceptOrder').removeAttribute('hidden');
				document.getElementById('modifyOrder').removeAttribute('hidden');
				break;
			case 2:
				document.getElementById('deliveryOrder').removeAttribute('hidden');
				document.getElementById('modifyOrder').removeAttribute('hidden');
				document.getElementById('cancelOrder').removeAttribute('hidden');
				break;
			case 3:
				document.getElementById('acceptOrder').removeAttribute('hidden');
				document.getElementById('returnOrder').removeAttribute('hidden');
				break;
			case 4:
				document.getElementById('closeOrder').removeAttribute('hidden');
				break;
			case 5:
				document.getElementById('handleReturn').removeAttribute('hidden');
				break;
			case 6:
				document.getElementById('completeReturn').removeAttribute('hidden');
				break;
			case 7:
				document.getElementById('acceptOrder').removeAttribute('hidden');
				break;
			case 8:
				break;
			case 9:
				break;
			case 0:
				break;
			default:
				break;
		}
	}
	checkStatus();

	var url = "@Url.Action("Index", "OrderManage")";

	function AcceptOrder() {
		$.ajax({
			url: '/Admin/OrderManage/AcceptOrder',
			type: 'POST',
			data: { id: @Model.Id },
			success: function (result) {
				if (result.success) {
					alert('Xác nhận thành công.');
					window.location.href = url;
				} else {
					alert('Xác nhận thất bại: ' + result.errorMessage);
				}
			},
			error: function (error) {
				alert('Có lỗi xảy ra: ' + error.responseText);
			}
		});
	}

	function DeliveryOrder() {
		$.ajax({
			url: '/Admin/OrderManage/DeliveryOrder',
			type: 'POST',
			data: { id: @Model.Id },
			success: function (result) {
				if (result.success) {
					alert('Xác nhận giao hàng thành công.');
					window.location.href = url;
				} else {
					alert('Xác nhận thất bại: ' + result.errorMessage);
				}
			},
			error: function (error) {
				alert('Có lỗi xảy ra: ' + error.responseText);
			}
		});
	}

	function SuccessOrder() {
		$.ajax({
			url: '/Admin/OrderManage/SuccessOrder',
			type: 'POST',
			data: { id: @Model.Id },
			success: function (result) {
				if (result.success) {
					alert('Xác nhận hoàn thành đơn hàng thành công.');
					window.location.href = url;
				} else {
					alert('Xác nhận thất bại: ' + result.errorMessage);
				}
			},
			error: function (error) {
				alert('Có lỗi xảy ra: ' + error.responseText);
			}
		});
	}

	function ReturnOrder() {
		var modifyChange = document.getElementById('modifyChange').value;
		if (modifyChange.trim() === "") {
			document.getElementById('valid').innerHTML("*Hãy thêm ghi chú về lý do trả hàng");
			document.getElementById('valid').removeAttribute('hidden');
		} 
		else {
			document.getElementById('valid').setAttribute('hidden', 'hidden');
			$.ajax({
				url: '/Admin/OrderManage/ReturnOrder',
				type: 'POST',
				data: { id: @Model.Id, modifyChange: modifyChange },
				success: function (result) {
					if (result.success) {
						alert('Xác nhận trả hàng thành công.');
						window.location.href = url;
					} else {
						alert('Xác nhận thất bại: ' + result.errorMessage);
					}
				},
				error: function (error) {
					alert('Có lỗi xảy ra: ' + error.responseText);
				}
			});
		}
	}

	function HandleReturn() {
		$.ajax({
			url: '/Admin/OrderManage/HandleReturn',
			type: 'POST',
			data: { id: @Model.Id },
			success: function (result) {
				if (result.success) {
					alert('Xác nhận hàng đã trả về thành công.');
					window.location.href = url;
				} else {
					alert('Xác nhận thất bại: ' + result.errorMessage);
				}
			},
			error: function (error) {
				alert('Có lỗi xảy ra: ' + error.responseText);
			}
		});
	}

	function SuccessReturn() {
		var modifyChange = document.getElementById('modifyChange').value;
		if (modifyChange.trim() === "") {
			document.getElementById('valid').innerHTML("*Thêm ghi chú cách xử lý đơn hàng trả về");
			document.getElementById('valid').removeAttribute('hidden');
		}
		else {
			document.getElementById('valid').setAttribute('hidden', 'hidden');
			$.ajax({
				url: '/Admin/OrderManage/SuccessReturn',
				type: 'POST',
				data: { id: @Model.Id, modifyChange: modifyChange },
				success: function (result) {
					if (result.success) {
						alert('Xác nhận xủ lý hàng trả thành công.');
						window.location.href = url;
					} else {
						alert('Xác nhận thất bại: ' + result.errorMessage);
					}
				},
				error: function (error) {
					alert('Có lỗi xảy ra: ' + error.responseText);
				}
			});
		}
	}

	function CancelOrder() {
		var modifyChange = document.getElementById('modifyChange').value;
		if (modifyChange.trim() === "") {
			document.getElementById('valid').innerHTML("*Hãy thêm lý do hủy đơn");
			document.getElementById('valid').removeAttribute('hidden');
		}
		else {
			document.getElementById('valid').setAttribute('hidden', 'hidden');
			$.ajax({
				url: '/Admin/OrderManage/CancelOrder',
				type: 'POST',
				data: { id: @Model.Id, modifyChange: modifyChange },
				success: function (result) {
					if (result.success) {
						alert('Xác nhận hủy đơn hàng thành công.');
						window.location.href = url;
					} else {
						alert('Xác nhận thất bại: ' + result.errorMessage);
					}
				},
				error: function (error) {
					alert('Có lỗi xảy ra: ' + error.responseText);
				}
			});
		}
	}

	function CloseOrder() {
		$.ajax({
			url: '/Admin/OrderManage/CloseOrder',
			type: 'POST',
			data: { id: @Model.Id },
			success: function (result) {
				if (result.success) {
					alert('Xác nhận đóng đơn hàng thành công.');
					window.location.href = url;
				} else {
					alert('Xác nhận thất bại: ' + result.errorMessage);
				}
			},
			error: function (error) {
				alert('Có lỗi xảy ra: ' + error.responseText);
			}
		});
	}
</script>
